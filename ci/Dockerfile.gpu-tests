# GPU Testing Image for lloyal.node
# Runs integration tests on NVIDIA L4 GPU via Cloud Run Jobs
#
# Build: docker build -f ci/Dockerfile.gpu-tests -t gpu-tests .
# Run:   docker run --gpus all gpu-tests

# CUDA 12.2.2 required for Cloud Run L4 GPU (driver 535.x supports up to 12.2.x)
FROM nvidia/cuda:12.2.2-runtime-ubuntu22.04

# Install Vulkan runtime, tools, and utilities
# NOTE: Do NOT install mesa-vulkan-drivers - it provides a software fallback
# that would let tests "pass" without real GPU hardware
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    curl \
    ca-certificates \
    jq \
    libgomp1 \
    libvulkan1 \
    vulkan-tools \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 24
RUN wget -qO- https://deb.nodesource.com/setup_24.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy package.json first for dependency caching
COPY package.json ./

# Install dependencies (omit dev deps - only need runtime deps like @lloyal-labs/tsampler)
RUN npm install --omit=dev

# Copy pre-built packages from release workflow
# These are downloaded as artifacts before docker build
COPY packages/ ./packages/

# Copy test files, examples, lib, and scripts
COPY test/ ./test/
COPY examples/ ./examples/
COPY lib/ ./lib/
COPY scripts/download-test-models.sh ./scripts/

# Models downloaded at runtime via run-gpu-tests.sh
# This allows testing multiple models from test/matrix.json
# without baking large files into the image

# Test script
COPY ci/run-gpu-tests.sh ./

# --- VULKAN FIX FOR CLOUD RUN ---
# Cloud Run mounts NVIDIA driver binaries but doesn't create the Vulkan ICD
# manifest that the Vulkan loader needs to discover the driver.
#
# 1. Create the missing NVIDIA ICD Manifest
#    This tells the Vulkan loader to use the NVIDIA library mounted by Cloud Run
RUN mkdir -p /etc/vulkan/icd.d && \
    echo '{ "file_format_version": "1.0.0", "ICD": { "library_path": "libGLX_nvidia.so.0", "api_version": "1.3.99" } }' \
    > /etc/vulkan/icd.d/nvidia_icd.json

# 2. Configure Environment Variables
#    - VK_ICD_FILENAMES: Point Vulkan loader to our ICD manifest
#    - NVIDIA_DRIVER_CAPABILITIES: Mount graphics libs (required for Vulkan, not just CUDA)
#    - NVIDIA_VISIBLE_DEVICES: Ensure GPU is visible
ENV VK_ICD_FILENAMES=/etc/vulkan/icd.d/nvidia_icd.json
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
ENV NVIDIA_VISIBLE_DEVICES=all
# --- END VULKAN FIX ---

ENTRYPOINT ["bash", "run-gpu-tests.sh"]
