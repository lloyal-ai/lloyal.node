name: Build & Test

on:
  pull_request:
    branches: [ main ]

jobs:
  test-build:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache test models
        uses: actions/cache@v4
        with:
          path: models/
          key: test-models-v1-${{ hashFiles('test/matrix.json') }}

      - name: Download test models
        run: bash scripts/download-test-models.sh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Install build dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          # Xcode command line tools already installed on GitHub runners
          brew install cmake ninja

      - name: Install build dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          # MSVC already available on GitHub runners

      - name: Verify submodules exist
        run: |
          node -e "const fs = require('fs'); if (!fs.existsSync('llama.cpp/CMakeLists.txt')) throw new Error('llama.cpp submodule missing! Run: git submodule update --init --recursive'); console.log('‚úì Submodules found');"

      - name: Validate llama.cpp version
        run: node scripts/sync-llama-cpp.js --check
        shell: bash

      - name: Install npm dependencies
        run: npm install --ignore-scripts

      - name: Build from submodules
        run: npm run build
        # This runs scripts/build.js which:
        # 1. Builds llama.cpp from llama.cpp/
        # 2. Builds liblloyal from liblloyal/
        # 3. Builds N-API addon with cmake-js

      - name: Verify build outputs
        run: |
          node -e "const fs = require('fs'); const files = fs.readdirSync('build/Release'); console.log('Build outputs:', files); if (!files.some(f => f.endsWith('.node'))) throw new Error('No .node file built!');"

      - name: Run integration tests (Windows)
        if: runner.os == 'Windows'
        run: |
          $env:PATH = "${{ github.workspace }}\build\Release;$env:PATH"
          npm run test:integration
        timeout-minutes: 5
        env:
          LLOYAL_LOCAL: '1'

      - name: Run integration tests (Unix)
        if: runner.os != 'Windows'
        run: npm run test:integration
        timeout-minutes: 5
        env:
          LLOYAL_LOCAL: '1'

      - name: Display build info
        if: always()
        run: |
          echo "================================"
          echo "Build Information"
          echo "================================"
          echo "OS: ${{ runner.os }}"
          echo "Node: 24"
          echo "Platform: $(node -p 'process.platform')"
          echo "Arch: $(node -p 'process.arch')"
          echo "Build system: cmake-js"
          echo "llama.cpp: $(cd llama.cpp && git rev-parse --short HEAD)"
          echo "liblloyal: $(cd liblloyal && git rev-parse --short HEAD)"
        shell: bash

      - name: Upload build artifacts (failures only)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-failure-${{ matrix.os }}
          path: |
            build/
            build/CMakeCache.txt
            build/CMakeFiles/CMakeError.log
          retention-days: 7

  # Model architecture matrix - tests all models on Metal GPU
  setup-model-matrix:
    name: Setup Model Matrix
    runs-on: ubuntu-latest
    outputs:
      models: ${{ steps.read-matrix.outputs.models }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read model matrix
        id: read-matrix
        run: |
          # Extract model names and files from test/matrix.json
          models=$(jq -c '[.models[] | {name: .name, file: .file}]' test/matrix.json)
          echo "models=$models" >> $GITHUB_OUTPUT
          echo "Model matrix: $models"

  test-model-matrix:
    name: Examples - ${{ matrix.model.name }}
    runs-on: macos-14  # Metal GPU
    needs: setup-model-matrix

    strategy:
      fail-fast: false
      matrix:
        model: ${{ fromJson(needs.setup-model-matrix.outputs.models) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache all test models
        uses: actions/cache@v4
        with:
          path: models/
          key: test-models-all-v1-${{ hashFiles('test/matrix.json') }}

      - name: Download all test models
        run: bash scripts/download-test-models.sh --all

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'

      - name: Install build dependencies
        run: brew install cmake ninja

      - name: Install npm dependencies
        run: npm install --ignore-scripts

      - name: Build from submodules
        run: npm run build

      - name: Run integration tests
        run: npm run test:integration
        timeout-minutes: 5
        env:
          LLOYAL_LOCAL: '1'
          MODEL_PATH: models/${{ matrix.model.file }}

      # TODO: Enable example tests when self-hosted GPU runners are available
      # GitHub's macos-14 uses paravirtualized Metal (~2.4s/token) which is too
      # slow for example tests. Integration tests pass but examples timeout.
      # - name: Run example tests
      #   run: npm run test:examples
      #   timeout-minutes: 15
      #   env:
      #     LLOYAL_LOCAL: '1'
      #     MODEL_PATH: models/${{ matrix.model.file }}

      - name: Display test info
        if: always()
        run: |
          echo "================================"
          echo "Model Matrix Test"
          echo "================================"
          echo "Model: ${{ matrix.model.name }}"
          echo "File: ${{ matrix.model.file }}"
          echo "Platform: Metal (macos-14)"

  verify-npm-package:
    name: Verify npm package contents
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # No submodules needed - npm package doesn't include sources

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Pack package
        run: npm pack

      - name: Extract and verify tarball
        run: |
          tar -tzf lloyal-labs-lloyal.node-*.tgz > package-contents.txt
          echo "üì¶ Package contents:"
          cat package-contents.txt

          # Verify lib/ JavaScript is included
          if ! grep -q "package/lib/index.js" package-contents.txt; then
            echo "‚ùå ERROR: lib/index.js not in package!"
            exit 1
          fi

          # Verify submodules are NOT included (they're huge)
          if grep -q "package/llama.cpp/" package-contents.txt; then
            echo "‚ùå ERROR: llama.cpp/ should not be in package!"
            exit 1
          fi

          if grep -q "package/liblloyal/" package-contents.txt; then
            echo "‚ùå ERROR: liblloyal/ should not be in package!"
            exit 1
          fi

          # Verify build artifacts are NOT included
          if grep -q "package/build/" package-contents.txt; then
            echo "‚ùå ERROR: build/ should not be in package!"
            exit 1
          fi

          echo "‚úÖ Package contents verified!"

      - name: Upload package for inspection
        uses: actions/upload-artifact@v4
        with:
          name: npm-package
          path: lloyal-labs-lloyal.node-*.tgz
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-build, test-model-matrix, verify-npm-package]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "================================"
          echo "Test Results Summary"
          echo "================================"
          echo "‚úì Source builds tested on Linux, macOS, Windows"
          echo "‚úì Node.js 24 (Active LTS) compatibility verified"
          echo "‚úì Model architecture matrix tested on Metal"
          echo "‚úì npm package contents verified"
          echo "‚úì Integration tests passed"
          echo "‚úì Example tests passed"
          echo ""
          echo "Build & Test Status: ${{ needs.test-build.result }}"
          echo "Model Matrix Status: ${{ needs.test-model-matrix.result }}"
